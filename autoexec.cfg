// Load SAR
plugin_load sar

// Update SAR if needed
sar_update release exit

// Disable a weird HUD that can appear in demo playback
sar_disable_coop_score_hud 1

// Blacklist certain commands from being run in demo playback
sar_demo_blacklist 1
sar_demo_blacklist_addcmd bind
sar_demo_blacklist_addcmd quit
sar_demo_blacklist_addcmd exit
sar_demo_blacklist_addcmd sar_exit
sar_demo_blacklist_addcmd sar_on_

// Stop the game from going to sleep when it loses focus
sar_disable_no_focus_sleep 1
snd_mute_losefocus 0

// Allow OOB vision
r_portal_use_pvs_optimization 0

// Fix portal rendering
r_portal_fastpath 0

// Developer 1 settings; the actual developer mode is set in
// per-category configs
contimes 6

// svar defaults
svar_set sp_cm_demo_name   "chapter$chapter/$map/%Y-%m-%d_%H-%M-%S"
svar_set coop_cm_demo_name "$role/course$course/$map/%Y-%m-%d_%H-%M-%S"

// SAR HUD
sar_hud_default_order_bottom text
sar_hud_default_font_index 1
sar_hud_default_padding_y 5
sar_hud_default_padding_x 5
sar_hud_default_spacing 5
sar_hud_bg 1
sar_hud_velocity 3
sar_hud_position 2
sar_hud_angles 1
sar_hud_demo 1

// We always want to be recording, so set this, even if the category
// uses autorecord
sar_record_at 0
sar_record_at_demo_name ""
// HACKHACK: really fucking cursed special case to mitigate inexplicable
// game crash
sar_on_load cond "map=mp_coop_wall_5" sar_record_at 30
sar_on_load cond "!map=mp_coop_wall_5" sar_record_at 0

// Dialogue toggle
sar_function snd_setdialogue "snd_setmixer potatosVO vol $1; snd_setmixer gladosVO vol $2; snd_setmixer announcerVO vol $3; snd_setmixer wheatleyVO vol $4; snd_setmixer caveVO vol $5; snd_setmixer coreVO vol $6"
sar_alias dialogue_off "sar_hud_set_text 0 Dialogue #FF5555OFF; sar_alias dialogue_toggle dialogue_on;  snd_setdialogue 0.01 0.01 0.01 0.01 0.01 0.01"
sar_alias dialogue_on  "sar_hud_set_text 0 Dialogue #55FF55ON;  sar_alias dialogue_toggle dialogue_off; snd_setdialogue 0.4  0.7  0.7  0.7  0.88 0.75"
dialogue_on

// Funneling toggle
sar_alias funneling_off "sar_hud_set_text 1 Funneling #FF5555OFF; sar_alias funneling_toggle funneling_on;  sv_player_funnel_into_portals 0"
sar_alias funneling_on  "sar_hud_set_text 1 Funneling #55FF55ON;  sar_alias funneling_toggle funneling_off; sv_player_funnel_into_portals 1"
funneling_on

// Fullbright toggle
sar_function ambient_rgb "mat_ambient_light_r $1; mat_ambient_light_g $1; mat_ambient_light_b $1"
sar_alias fullbright_on  "sar_alias fullbright_toggle fullbright_off; ambient_rgb 0.1"
sar_alias fullbright_off "sar_alias fullbright_toggle fullbright_on;  ambient_rgb 0.0"
fullbright_off

// Sensitivity toggle
sar_alias sensitivity_on "svar_from_cvar old_sens sensitivity; sensitivity 0.01; sar_alias sensitivity_toggle sensitivity_off"
sar_function sensitivity_off "sensitivity $old_sens; sar_alias sensitivity_toggle sensitivity_on"
sar_alias sensitivity_toggle sensitivity_on

// Use-swap toggle
sar_alias useswap_on  "sar_alias useswap_toggle useswap_off; sar_alias +scrollup1 +use;  sar_alias -scrollup1 -use"
sar_alias useswap_off "sar_alias useswap_toggle useswap_on;  sar_alias +scrollup1 +jump; sar_alias -scrollup1 -jump"
useswap_off

// Supershoot
// THE 'nop's IN THIS ARE IMPORTANT! They stop the supershoot keycode
// being carried across into the alias.
sar_alias +supershoot "sar_alias +scrollup +attack;    sar_alias -scrollup -attack;    sar_alias +scrolldown +attack; sar_alias -scrolldown -attack; nop"
sar_alias -supershoot "sar_alias +scrollup +scrollup1; sar_alias -scrollup -scrollup1; sar_alias +scrolldown +jump;   sar_alias -scrolldown -jump;   nop"
-supershoot

// FPS toggle bind
sar_alias 30fps_on "svar_from_cvar old_fps fps_max; fps_max 30; sar_alias 30fps_toggle 30fps_off"
sar_function 30fps_off "fps_max $old_fps; sar_alias 30fps_toggle 30fps_on"
sar_alias 30fps_toggle 30fps_on

// contimes bind
sar_alias contimes_on  "con_drawnotify 1; sar_alias contimes_toggle contimes_off"
sar_alias contimes_off "con_drawnotify 0; sar_alias contimes_toggle contimes_on"
contimes_off

// Toast settings
sar_toast_width 500
sar_toast_setpos bottom center

// Perform map detection, setting the appropriate svars
sar_on_load exec map_detect

// Black magic to create categories
sar_function __force_warn echo "Forcing category $1. Run 'auto' to re-enable automatic category selection."
svar_set __detect_cur 0
svar_set __detect_nxt 1
sar_alias __detect_0 nop
sar_alias __record record ""
sar_function __add_cat_h1 sar_alias $1 "stop; svar_set category $1; __force_warn $1; svar_set force_cat 1; exec cats/$1; __record"
sar_function __add_cat_h2 sar_alias __detect_$__detect_cur "__detect_cat_$1; __detect_$__detect_nxt"
sar_function __add_cat_h3 "sar_alias __detect_cat_$1 nop; sar_alias __detect_$__detect_nxt nop; svar_add __detect_cur 1; svar_add __detect_nxt 1"
sar_function add_cat "__add_cat_h1 $1; __add_cat_h2 $1; __add_cat_h3 $1"
sar_function detect_cat sar_alias __detect_cat_$1 cond "!var:category=$1 & ($2)" "stop; svar_set category $1"

// Category autoselection
sar_alias auto cond "var:force_cat=1" "svar_set force_cat 0; stop; __detect_0; sar_expand exec cats/$category; __record"
sar_on_load cond "!var:no_auto_category=1 & !var:force_cat=1" __detect_0

// Run category exec on load
sar_on_load sar_expand exec cats/$category

// Create the built-in categories
add_cat fullgame
add_cat anypc
add_cat sp_cm
add_cat amc
add_cat ac
add_cat coop_cm

// Add the auto-selection for all the built-in categories
detect_cat fullgame "!cm & !coop"
detect_cat sp_cm     "cm & !coop"
detect_cat amc      "!cm &  coop"
detect_cat coop_cm   "cm &  coop"

// Dialogue fade toasts
sar_toast_tag_set_duration fade forever
sar_on_load sar_toast_tag_dismiss_all fade
sar_on_load cond "!var:no_dialogue_toasts=1 & !var:no_dialogue_toasts_coop=1 & (var:category=amc | var:category=ac)" exec dialogue_toasts/coop
sar_on_load cond "!var:no_dialogue_toasts=1 & !var:no_dialogue_toasts_sp=1   & var:category=fullgame"                exec dialogue_toasts/sp

// Category cond aliases for rule differences
sar_alias cm_only cond "var:category=sp_cm | var:category=coop_cm"
sar_alias non_cm_only cond "!var:category=sp_cm & !var:category=coop_cm"

// Add the mtrigger categories and the sar_on_load execs
// We do this *after* running the category exec, so that no_mtriggers is set if
// necessary
exec mtriggers/mtriggers

// When we open the game, assume we're running fullgame at first, just
// as a sane default
svar_set category fullgame
exec cats/fullgame

// Exec personal config
exec extra
